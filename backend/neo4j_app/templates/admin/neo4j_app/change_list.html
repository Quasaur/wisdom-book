{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/changelists.css' %}">
  <style>
    .dashboard-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .dashboard-card {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 15px;
      background-color: #fff;
    }
    .dashboard-card h2 {
      margin-top: 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .stats-table {
      width: 100%;
      border-collapse: collapse;
    }
    .stats-table th, .stats-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .stats-table th {
      background-color: #f5f5f5;
    }
    .error-entry {
      margin-bottom: 15px;
      padding: 10px;
      background-color: #fff8f8;
      border-left: 3px solid #f44336;
    }
    .warning-entry {
      margin-bottom: 15px;
      padding: 10px;
      background-color: #fffde7;
      border-left: 3px solid #ffeb3b;
    }
    .entry-meta {
      color: #666;
      font-size: 0.85em;
    }
    .entry-message {
      margin: 5px 0;
    }
  </style>
{% endblock %}

{% block content %}
<div id="content-main">
  <div class="module" id="changelist">
    <div class="dashboard-header">
      <h1>Neo4j Dashboard</h1>
      <div class="actions">
        <a href="{% url 'admin:neo4j_logs' %}" class="button">View All Logs</a>
        <a href="{% url 'admin:index' %}" class="button">Back to Admin</a>
      </div>
    </div>

    <div class="dashboard-container">
      <!-- Performance Stats -->
      <div class="dashboard-card">
        <h2>Query Performance</h2>
        {% if query_stats %}
          <table class="stats-table">
            <thead>
              <tr>
                <th>Query</th>
                <th>Avg Time</th>
                <th>Count</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for stat in query_stats %}
                <tr>
                  <td>{{ stat.name }}</td>
                  <td>{{ stat.avg_time_ms|floatformat:2 }} ms</td>
                  <td>{{ stat.count }}</td>
                  <td>
                    <a href="{% url 'admin:neo4j_query_detail' stat.name %}">Details</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No query statistics available.</p>
          {% if query_stats_error %}
            <div class="error-entry">
              <div class="entry-message">{{ query_stats_error }}</div>
            </div>
          {% endif %}
        {% endif %}
      </div>

      <!-- Recent Errors -->
      <div class="dashboard-card">
        <h2>Recent Errors</h2>
        {% if recent_errors %}
          {% for entry in recent_errors %}
            <div class="error-entry">
              <div class="entry-meta">
                {{ entry.timestamp }} - {{ entry.query_name }}
              </div>
              <div class="entry-message">{{ entry.message }}</div>
              {% if entry.solution %}
                <div class="entry-solution">
                  <strong>Solution:</strong> {{ entry.solution.title }}
                </div>
                <a href="{% url 'admin:neo4j_query_detail' entry.query_name %}">View Details</a>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <p>No recent errors found.</p>
        {% endif %}
      </div>

      <!-- Log Summary -->
      <div class="dashboard-card">
        <h2>Log Summary</h2>
        {% if level_counts %}
          <table class="stats-table">
            <thead>
              <tr>
                <th>Level</th>
                <th>Count</th>
              </tr>
            </thead>
            <tbody>
              {% for level, count in level_counts.items %}
                <tr>
                  <td>{{ level }}</td>
                  <td>{{ count }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No log data available.</p>
        {% endif %}
      </div>

      <!-- Endpoint Stats -->
      <div class="dashboard-card">
        <h2>Endpoint Usage</h2>
        {% if path_counts %}
          <table class="stats-table">
            <thead>
              <tr>
                <th>Endpoint</th>
                <th>Count</th>
              </tr>
            </thead>
            <tbody>
              {% for path, count in path_counts.items %}
                <tr>
                  <td>{{ path }}</td>
                  <td>{{ count }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No endpoint data available.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
