{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/changelists.css' %}">
  <style>
    .dashboard-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .dashboard-card {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 15px;
      background-color: #fff;
    }
    .dashboard-card h2 {
      margin-top: 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .stats-table {
      width: 100%;
      border-collapse: collapse;
    }
    .stats-table th, .stats-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .stats-table th {
      background-color: #f5f5f5;
    }
    .log-entry {
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 4px;
    }
    .log-entry.error {
      background-color: #fff8f8;
      border-left: 4px solid #f44336;
    }
    .log-entry.warning {
      background-color: #fffde7;
      border-left: 4px solid #ffeb3b;
    }
    .log-entry.info {
      background-color: #f1f8e9;
      border-left: 4px solid #8bc34a;
    }
    .log-entry-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .log-entry-timestamp {
      color: #666;
      font-size: 0.9em;
    }
    .log-entry-level {
      font-weight: bold;
    }
    .log-entry-message {
      margin-bottom: 10px;
    }
    .log-entry-meta {
      font-size: 0.9em;
      color: #666;
      margin-top: 10px;
    }
    .solution-card {
      background-color: #e8f5e9;
      border-left: 4px solid #4caf50;
      padding: 15px;
      margin-bottom: 20px;
    }
    .solution-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .solution-description {
      margin-bottom: 10px;
    }
    .solution-example {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
{% endblock %}

{% block content %}
<div id="content-main">
  <div class="module" id="changelist">
    <div class="dashboard-header">
      <h1>Query Details: {{ query_name }}</h1>
      <div class="actions">
        <a href="{% url 'admin:neo4j_logs' %}?query_name={{ query_name }}" class="button">View All Logs</a>
        <a href="{% url 'admin:neo4j_dashboard' %}" class="button">Back to Dashboard</a>
      </div>
    </div>

    <div class="dashboard-container">
      <!-- Query Stats -->
      <div class="dashboard-card">
        <h2>Performance Statistics</h2>
        {% if stats %}
          <table class="stats-table">
            <tr>
              <th>Total Executions:</th>
              <td>{{ stats.count }}</td>
            </tr>
            <tr>
              <th>Avg Time:</th>
              <td>{{ stats.avg_time_ms|floatformat:2 }} ms</td>
            </tr>
            <tr>
              <th>Max Time:</th>
              <td>{{ stats.max_time_ms|floatformat:2 }} ms</td>
            </tr>
            <tr>
              <th>Min Time:</th>
              <td>{{ stats.min_time_ms|floatformat:2 }} ms</td>
            </tr>
          </table>
        {% else %}
          <p>No statistics available for this query.</p>
        {% endif %}
      </div>

      <!-- Error Solution -->
      {% if solution %}
        <div class="dashboard-card">
          <h2>Error Solution</h2>
          <div class="solution-card">
            <div class="solution-title">{{ solution.title }}</div>
            <div class="solution-description">{{ solution.description }}</div>
            <div class="solution-action">
              <strong>Recommended Action:</strong> {{ solution.solution }}
            </div>
            <div class="solution-example">{{ solution.example }}</div>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Recent Executions -->
    <div class="dashboard-card">
      <h2>Recent Executions</h2>
      {% if entries %}
        {% for entry in entries %}
          <div class="log-entry {{ entry.level|lower }}">
            <div class="log-entry-header">
              <div class="log-entry-timestamp">{{ entry.timestamp }}</div>
              <div class="log-entry-level">{{ entry.level }}</div>
            </div>
            <div class="log-entry-message">{{ entry.message }}</div>
            {% if entry.duration_ms %}
              <div class="log-entry-meta">Duration: {{ entry.duration_ms|floatformat:2 }} ms</div>
            {% endif %}
            {% if entry.path %}
              <div class="log-entry-meta">Endpoint: {{ entry.path }}</div>
            {% endif %}
            {% if entry.query_text %}
              <div class="log-entry-query">
                <strong>Query:</strong>
                <pre>{{ entry.query_text }}</pre>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <p>No log entries found for this query.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
