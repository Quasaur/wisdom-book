{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/changelists.css' %}">
  <style>
    .filter-form {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f8f8;
      border-radius: 4px;
    }
    .filter-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .filter-form select, .filter-form input {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .filter-form button {
      padding: 6px 15px;
      background-color: #417690;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .filter-form button:hover {
      background-color: #2b5070;
    }
    .log-entry {
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 4px;
    }
    .log-entry.error {
      background-color: #fff8f8;
      border-left: 4px solid #f44336;
    }
    .log-entry.warning {
      background-color: #fffde7;
      border-left: 4px solid #ffeb3b;
    }
    .log-entry.info {
      background-color: #f1f8e9;
      border-left: 4px solid #8bc34a;
    }
    .log-entry-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .log-entry-timestamp {
      color: #666;
      font-size: 0.9em;
    }
    .log-entry-level {
      font-weight: bold;
    }
    .log-entry-message {
      margin-bottom: 10px;
    }
    .log-entry-meta {
      font-size: 0.9em;
      color: #666;
      margin-top: 10px;
    }
    .pagination {
      margin-top: 20px;
      text-align: center;
    }
  </style>
{% endblock %}

{% block content %}
<div id="content-main">
  <div class="module" id="changelist">
    <div class="dashboard-header">
      <h1>Neo4j Query Logs</h1>
      <div class="actions">
        <a href="{% url 'admin:neo4j_dashboard' %}" class="button">Back to Dashboard</a>
      </div>
    </div>

    <form class="filter-form" method="get">
      <div>
        <label for="level">Log Level</label>
        <select name="level" id="level">
          <option value="">All Levels</option>
          <option value="ERROR" {% if filter_level == 'ERROR' %}selected{% endif %}>ERROR</option>
          <option value="WARNING" {% if filter_level == 'WARNING' %}selected{% endif %}>WARNING</option>
          <option value="INFO" {% if filter_level == 'INFO' %}selected{% endif %}>INFO</option>
        </select>
      </div>
      
      <div>
        <label for="query_name">Query Name</label>
        <input type="text" name="query_name" id="query_name" value="{{ query_name|default:'' }}">
      </div>
      
      <div>
        <label for="path">Endpoint Path</label>
        <input type="text" name="path" id="path" value="{{ path|default:'' }}">
      </div>
      
      <div>
        <label for="error_only">
          <input type="checkbox" name="error_only" id="error_only" value="1" {% if error_only %}checked{% endif %}>
          Errors Only
        </label>
      </div>
      
      <div>
        <button type="submit">Apply Filters</button>
        <a href="{% url 'admin:neo4j_logs' %}" class="button">Clear</a>
      </div>
    </form>

    <div class="log-entries">
      {% if entries %}
        {% for entry in entries %}
          <div class="log-entry {{ entry.level|lower }}">
            <div class="log-entry-header">
              <div class="log-entry-timestamp">{{ entry.timestamp }}</div>
              <div class="log-entry-level">{{ entry.level }}</div>
            </div>
            <div class="log-entry-message">{{ entry.message }}</div>
            {% if entry.query_name %}
              <div class="log-entry-meta">
                Query: <a href="{% url 'admin:neo4j_query_detail' entry.query_name %}">{{ entry.query_name }}</a>
                {% if entry.duration_ms %} | Duration: {{ entry.duration_ms|floatformat:2 }} ms{% endif %}
                {% if entry.is_slow %} | <strong>SLOW QUERY</strong>{% endif %}
              </div>
            {% endif %}
            {% if entry.path %}
              <div class="log-entry-meta">Endpoint: {{ entry.path }}</div>
            {% endif %}
            {% if entry.solution %}
              <div class="log-entry-solution">
                <strong>Suggested Solution:</strong> {{ entry.solution.title }}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <p>No log entries found.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
